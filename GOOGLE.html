<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>KML / KMZ Viewer â€“ Advanced Buffer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css">

<style>
html,body,#map{height:100%;margin:0;}

#panel{
  position:absolute;
  top:10px; left:10px;
  z-index:1000;
  background:#fff;
  padding:10px;
  width:280px;
  font-family:Arial;
  box-shadow:0 0 10px rgba(0,0,0,.4);
}

.kml-label{
  color:#fff;
  font-weight:bold;
  text-shadow:2px 2px 4px #000;
  pointer-events:none;
  white-space:nowrap;
}

input,button{width:100%;margin-top:4px;}
</style>
</head>

<body>

<div id="panel">
  <input type="file" id="fileInput" accept=".kml,.kmz" multiple>

  <hr>
  <button onclick="toggleLabels()">Text ON / OFF</button>

  <hr>
  <b>Geometry</b><br>
  <input type="checkbox" id="ptChk" checked> Points<br>
  <input type="checkbox" id="lnChk" checked> Lines<br>
  <input type="checkbox" id="pgChk" checked> Polygons

  <hr>
  <b>ðŸŸ  Buffer Tool</b>
  <input type="number" id="bufDist" value="20" placeholder="Distance (meters)">
  <label>Color</label>
  <input type="color" id="bufColor" value="#00ffff">
  <label>Opacity: <span id="bufValue">0.3</span></label>
  <input type="range" id="bufOpacity" min="0" max="1" step="0.1" value="0.3">

  <b>Buffer Area:</b>
  <div id="bufArea">0 sqm</div>

  <button onclick="createBuffer()">Generate Buffer</button>
  <button onclick="clearBuffer()">Clear Buffer</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.6.0/dist/togeojson.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.polylinemeasure/Leaflet.PolylineMeasure.min.js"></script>

<script>
// ================= MAP =================
const satellite=L.tileLayer(
 "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
 {maxZoom:22}
);

const map=L.map("map",{
  center:[22,78],
  zoom:4,
  layers:[satellite],
  zoomControl:false
});

L.control.polylineMeasure({position:"topright"}).addTo(map);

// ================= GLOBAL =================
const pointGroup=L.layerGroup().addTo(map);
const lineGroup=L.layerGroup().addTo(map);
const polyGroup=L.layerGroup().addTo(map);
const bufferGroup=L.layerGroup().addTo(map);
const labels=[];

let selectedFeatures=[];
let labelsVisible=false;   // â­ DEFAULT OFF

const POINT_ZOOM=16;
const LABEL_ZOOM=14;

// ================= FILE LOAD =================
fileInput.onchange=e=>{
  [...e.target.files].forEach(f=>{
    if(f.name.endsWith(".kml")) loadKML(f);
    if(f.name.endsWith(".kmz")) loadKMZ(f);
  });
};

function loadKML(file){
  const r=new FileReader();
  r.onload=()=>{
    addGeo(toGeoJSON.kml(
      new DOMParser().parseFromString(r.result,"text/xml")
    ));
  };
  r.readAsText(file);
}

function loadKMZ(file){
  JSZip.loadAsync(file).then(zip=>{
    zip.forEach((p,e)=>{
      if(p.endsWith(".kml")){
        e.async("string").then(t=>{
          addGeo(toGeoJSON.kml(
            new DOMParser().parseFromString(t,"text/xml")
          ));
        });
      }
    });
  });
}

// ================= ADD DATA =================
function addGeo(gj){
  const layer=L.geoJSON(gj,{
    style:f=>{
      if(f.geometry.type.includes("Polygon"))
        return{color:"red",fillOpacity:.3};
      if(f.geometry.type.includes("Line"))
        return{color:"yellow",weight:3};
    },

    pointToLayer:(f,ll)=>{
      const m=L.marker(ll);
      pointGroup.addLayer(m);
      return m;
    },

    onEachFeature:(f,l)=>{
      if(l instanceof L.Polygon) polyGroup.addLayer(l);
      if(l instanceof L.Polyline) lineGroup.addLayer(l);

      // MULTI SELECTION
      l.on("click",()=>{
        if(selectedFeatures.includes(l)){
          selectedFeatures=selectedFeatures.filter(x=>x!==l);
          l.setStyle?.({color:l instanceof L.Polygon?"red":"yellow"});
        }else{
          selectedFeatures.push(l);
          l.setStyle?.({color:"#00ff00"});
        }
      });

      if(f.properties?.name){
        const lbl=L.marker(
          l.getBounds?.()?.getCenter?.()||l.getLatLng(),
          {icon:L.divIcon({className:"kml-label",html:f.properties.name})}
        );
        labels.push(lbl);
      }
    }
  }).addTo(map);

  // AUTO ZOOM but SAFE (labels nahi dikhenge)
  map.fitBounds(layer.getBounds(),{padding:[40,40]});
  if(map.getZoom()>=LABEL_ZOOM) map.setZoom(LABEL_ZOOM-1);

  refreshVisibility();
}

// ================= VISIBILITY =================
function refreshVisibility(){
  const z=map.getZoom();

  z>=POINT_ZOOM && ptChk.checked
    ? map.addLayer(pointGroup)
    : map.removeLayer(pointGroup);

  lnChk.checked?map.addLayer(lineGroup):map.removeLayer(lineGroup);
  pgChk.checked?map.addLayer(polyGroup):map.removeLayer(polyGroup);

  labels.forEach(l=>map.removeLayer(l));
  if(labelsVisible && z>=LABEL_ZOOM)
    labels.forEach(l=>map.addLayer(l));
}

map.on("zoomend",refreshVisibility);
ptChk.onchange=refreshVisibility;
lnChk.onchange=refreshVisibility;
pgChk.onchange=refreshVisibility;

function toggleLabels(){
  labelsVisible=!labelsVisible;
  refreshVisibility();
}

// ================= BUFFER =================
bufOpacity.oninput=()=>bufValue.innerText=bufOpacity.value;

function createBuffer(){
  bufferGroup.clearLayers();
  let totalArea=0;

  const dist=Number(bufDist.value)/1000;
  const targets=selectedFeatures.length
    ? selectedFeatures
    : [...pointGroup.getLayers(),...lineGroup.getLayers(),...polyGroup.getLayers()];

  targets.forEach(l=>{
    const buffer=turf.buffer(l.toGeoJSON(),dist,{units:"kilometers"});
    totalArea+=turf.area(buffer);

    L.geoJSON(buffer,{
      style:{
        color:bufColor.value,
        weight:2,
        fillOpacity:Number(bufOpacity.value)
      }
    }).addTo(bufferGroup);
  });

  document.getElementById("bufArea").innerText=
    totalArea.toFixed(2)+" sqm";
}

function clearBuffer(){
  bufferGroup.clearLayers();
  selectedFeatures=[];
  document.getElementById("bufArea").innerText="0 sqm";
}
</script>

</body>
</html>
