<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>KML / KMZ Viewer â€“ Advanced Buffer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css">

<style>
html,body,#map{height:100%;margin:0;}

#panel{
  position:absolute;
  top:10px; left:10px;
  z-index:1000;
  background:#fff;
  padding:10px;
  width:280px;
  font-family:Arial;
  box-shadow:0 0 10px rgba(0,0,0,.4);
}

.kml-label{
  color:#fff;
  font-weight:bold;
  text-shadow:2px 2px 4px #000;
  pointer-events:none;
}

input,button{width:100%;margin-top:4px;}
</style>
</head>

<body>

<div id="panel">
  <input type="file" id="fileInput" accept=".kml,.kmz" multiple>

  <hr>
  <button onclick="toggleLabels()">Text ON / OFF</button>

  <hr>
  <b>Geometry</b><br>
  <input type="checkbox" id="ptChk" checked> Points<br>
  <input type="checkbox" id="lnChk" checked> Lines<br>
  <input type="checkbox" id="pgChk" checked> Polygons

  <hr>
  <b>ðŸŸ  Buffer Tool</b>
  <input type="number" id="bufDist" value="20" placeholder="Distance (meters)">
  <label>Color</label>
  <input type="color" id="bufColor" value="#00ffff">
  <label>Opacity: <span id="bufValue">0.3</span></label>
  <input type="range" id="bufOpacity" min="0" max="1" step="0.1" value="0.3">

  <button onclick="createBuffer()">Generate Buffer</button>
  <button onclick="clearBuffer()">Clear Buffer</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.6.0/dist/togeojson.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.polylinemeasure/Leaflet.PolylineMeasure.min.js"></script>

<script>
// ================= MAP =================
const satellite=L.tileLayer(
 "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
 {maxZoom:22}
);

// Left zoom buttons remove, only attribution
const map=L.map("map",{center:[22,78],zoom:4,layers:[satellite],zoomControl:false});
L.control.attribution({position:"bottomright"}).addTo(map);
L.control.polylineMeasure({position:"topright"}).addTo(map);

// ================= GLOBAL =================
const pointGroup=L.layerGroup().addTo(map);
const lineGroup=L.layerGroup().addTo(map);
const polyGroup=L.layerGroup().addTo(map);
const bufferGroup=L.layerGroup().addTo(map);
const labels=[];

let selectedFeature=null;
let labelsVisible=true;

const POINT_ZOOM=16;
const LABEL_ZOOM=13;

// ================= FILE LOAD =================
fileInput.onchange=e=>{
  [...e.target.files].forEach(f=>{
    if(f.name.endsWith(".kml")) loadKML(f);
    if(f.name.endsWith(".kmz")) loadKMZ(f);
  });
};

function loadKML(file){
  const r=new FileReader();
  r.onload=()=>{
    const kml=new DOMParser().parseFromString(r.result,"text/xml");
    addGeo(toGeoJSON.kml(kml));
  };
  r.readAsText(file);
}

function loadKMZ(file){
  JSZip.loadAsync(file).then(zip=>{
    zip.forEach((p,e)=>{
      if(p.endsWith(".kml")){
        e.async("string").then(t=>{
          const kml=new DOMParser().parseFromString(t,"text/xml");
          addGeo(toGeoJSON.kml(kml));
        });
      }
    });
  });
}

// ================= ADD DATA =================
function addGeo(gj){
  L.geoJSON(gj,{
    style:f=>{
      if(f.geometry.type.includes("Polygon"))
        return{color:"red",fillOpacity:.3};
      if(f.geometry.type.includes("Line"))
        return{color:"yellow",weight:3};
    },

    pointToLayer:(f,ll)=>{
      const m=L.marker(ll,{
        icon:L.icon({
          iconUrl:"https://cdn-icons-png.flaticon.com/512/252/252025.png",
          iconSize:[14,14],
          iconAnchor:[7,14]
        })
      });
      pointGroup.addLayer(m);
      return m;
    },

    onEachFeature:(f,l)=>{
      if(l instanceof L.Polygon) polyGroup.addLayer(l);
      if(l instanceof L.Polyline) lineGroup.addLayer(l);

      // â­ SELECT FEATURE FOR BUFFER
      l.on("click",()=>{
        selectedFeature=l;
        l.setStyle?.({color:"#00ff00"});
      });

      if(f.properties?.name){
        const lbl=L.marker(
          l.getBounds?.()?.getCenter?.()||l.getLatLng(),
          {icon:L.divIcon({className:"kml-label",html:f.properties.name})}
        );
        labels.push(lbl);
      }
    }
  }).addTo(map);

  refreshVisibility();
}

// ================= ZOOM VISIBILITY =================
function refreshVisibility(){
  const z=map.getZoom();

  if(ptChk.checked && z>=POINT_ZOOM) map.addLayer(pointGroup);
  else map.removeLayer(pointGroup);

  lnChk.checked?map.addLayer(lineGroup):map.removeLayer(lineGroup);
  pgChk.checked?map.addLayer(polyGroup):map.removeLayer(polyGroup);

  labels.forEach(l=>map.removeLayer(l));
  if(labelsVisible && z>=LABEL_ZOOM)
    labels.forEach(l=>map.addLayer(l));
}

map.on("zoomend",refreshVisibility);
ptChk.onchange=refreshVisibility;
lnChk.onchange=refreshVisibility;
pgChk.onchange=refreshVisibility;

function toggleLabels(){
  labelsVisible=!labelsVisible;
  refreshVisibility();
}

// ================= BUFFER =================
const bufSlider=document.getElementById("bufOpacity");
const bufValue=document.getElementById("bufValue");
bufSlider.oninput=()=>{ bufValue.innerText=bufSlider.value; };

function createBuffer(){
  bufferGroup.clearLayers();

  const dist=Number(bufDist.value)/1000;
  const color=bufColor.value;
  const op=Number(bufOpacity.value);

  const targets = selectedFeature
    ? [selectedFeature]
    : [...pointGroup.getLayers(),
       ...lineGroup.getLayers(),
       ...polyGroup.getLayers()];

  targets.forEach(l=>{
    const gj=l.toGeoJSON();
    const buf=turf.buffer(gj,dist,{units:"kilometers"});

    L.geoJSON(buf,{
      style:{
        color:color,
        weight:2,
        fillOpacity:op
      }
    }).addTo(bufferGroup);
  });
}

function clearBuffer(){
  bufferGroup.clearLayers();
  selectedFeature=null;
}
</script>

</body>
</html>
