<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>KML / KMZ Viewer â€“ 2D + Real 3D</title>

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css">

<!-- CESIUM -->
<link href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

<style>
html,body{height:100%;margin:0;}

#map,#cesiumContainer{
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
}

#cesiumContainer{display:none;}

#panel{
  position:absolute;
  top:10px; left:10px;
  z-index:2000;
  background:#fff;
  padding:10px;
  width:280px;
  font-family:Arial;
  box-shadow:0 0 10px rgba(0,0,0,.4);
}

.kml-label{
  color:#fff;
  font-weight:bold;
  text-shadow:2px 2px 4px #000;
  pointer-events:none;
}

#heightSlider{width:100%;}
</style>
</head>

<body>

<div id="panel">
  <input type="file" id="fileInput" accept=".kml,.kmz" multiple><br><br>

  <button onclick="toggle3D()">ðŸ§± 3D View</button>
  <button onclick="exit3D()">â¬… 2D View</button>

  <div id="heightPanel" style="display:none;">
    <hr>
    Building Height
    <input type="range" id="heightSlider" min="10" max="300" value="50">
  </div>
</div>

<div id="map"></div>
<div id="cesiumContainer"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.6.0/dist/togeojson.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.polylinemeasure/Leaflet.PolylineMeasure.min.js"></script>

<script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>

<script>
// ================= LEAFLET MAP =================
const map = L.map("map",{center:[22,78],zoom:4});
L.tileLayer(
 "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
 {maxZoom:22,maxNativeZoom:19}
).addTo(map);

// ================= CESIUM =================
Cesium.Ion.defaultAccessToken = ""; // optional

const viewer = new Cesium.Viewer("cesiumContainer",{
  terrainProvider: Cesium.createWorldTerrain(),
  timeline:false,
  animation:false
});

let cesiumDataSource=null;

// ================= FILE LOAD =================
fileInput.addEventListener("change",e=>{
  [...e.target.files].forEach(f=>{
    loadInCesium(f);
  });
});

function loadInCesium(file){
  const url = URL.createObjectURL(file);
  Cesium.KmlDataSource.load(url,{
    camera:viewer.scene.camera,
    canvas:viewer.scene.canvas,
    clampToGround:false
  }).then(ds=>{
    if(cesiumDataSource) viewer.dataSources.remove(cesiumDataSource);
    cesiumDataSource=ds;
    viewer.dataSources.add(ds);
    viewer.zoomTo(ds);
    applyHeight();
  });
}

// ================= HEIGHT =================
heightSlider.oninput=applyHeight;

function applyHeight(){
  if(!cesiumDataSource) return;
  const h=+heightSlider.value;

  cesiumDataSource.entities.values.forEach(e=>{
    if(e.polygon){
      e.polygon.extrudedHeight = h;
      e.polygon.material = Cesium.Color.ORANGE.withAlpha(0.6);
    }
  });
}

// ================= MODE TOGGLE =================
function toggle3D(){
  map.getContainer().style.display="none";
  cesiumContainer.style.display="block";
  heightPanel.style.display="block";
  viewer.resize();
}

function exit3D(){
  cesiumContainer.style.display="none";
  map.getContainer().style.display="block";
  heightPanel.style.display="none";
}
</script>

</body>
</html>
